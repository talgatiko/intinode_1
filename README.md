 intinode_1
 Концепцию intinode — механизма ленивой загрузки файлов по хешу на уровне ядра Linux. Он позволяет хранить в контейнерных образах, образах ВМ, AppImage, Flatpak и Snap только метаданные, а сами файлы загружать по требованию в общий кеш.
Интернет-иноды: как избавить облака от 90% мёртвых байтов





TL;DR: Представляем концепцию intinode — механизма ленивой загрузки файлов по хешу на уровне ядра Linux. Он позволяет хранить в контейнерных образах, образах ВМ, AppImage, Flatpak и Snap только метаданные, а сами файлы загружать по требованию в общий кеш. В облаке — экономия от 90% дискового пространства, на ноутбуке — меньше SSD-трафика и быстрее запуск приложений. И всё это — без единой строчки изменений в прикладном коде.

### Заготовка стандарта: **internet inode (intinode)**  
**Версия:** 10.3-draft  
**Статус:** Предложение для обсуждения  
**Дата:** 1 декабря 2025 г.  

---

#### 1. Цель  
Оптимизация хранения и передачи данных через ленивую загрузку **неизменяемых** файлов по хешу на уровне ядра ОС с общим локальным кешем.  

---

#### 2. Ключевые принципы  
- **Контентная адресация**: Файл идентифицируется хешем содержимого (SHA-256).  
- **Иммутабельность**: Файлы в источниках не изменяются.  
- **Минимализм ядра**: Логика загрузки вынесена в userspace-демон.  
- **Совместимость**: Работает с существующими инструментами (tar, OCI-registry).  

---

#### 3. Архитектура  
- **Ядро Linux**:  
  - Модуль `intinode.ko` распознаёт специальные файлы по магической строке `intinode ` (первые 8 байт: `69 6e 74 69 6e 6f 64 65`).  
  - Перехватывает `read()`, `execve()`, `mmap()` для таких файлов.  
  - Возвращает `EAGAIN` при отсутствии данных в кеше, передавая управление демону.  
- **Демон `intinode-fetchd`**:  
  - Работает в userspace с минимальными привилегиями (seccomp, namespaces).  
  - Загружает файлы из указанных источников (OCI/S3/HTTP).  
  - Верифицирует хеш и размер после загрузки.  
  - Управляет кешем: очистка по LRU + частота обращений.  
- **Локальный кеш хоста**:  
  - Путь: `/var/cache/intinode/<алгоритм>/<хеш>`.  
  - Хранение: файлы в несжатом виде по умолчанию.  
  - Доступ: общий для всех контейнеров/ВМ/приложений на хосте.  

---

#### 4. Формат специального файла  
```text  
intinode {"digest":"sha256:abc123...", "size":12345678, "urls":[...], "compressed": false}  
```  
- **Магическая строка**: Обязательные первые 8 байт для идентификации.  
- **Метаданные**:  
  - Формат обсуждается (JSON/protobuf/binary). Текущая предложение JSON для простоты.  
  - Обязательные поля: `digest`, `size`, `urls`.  
  - Опциональные:  
    - `compressed` (флаг сжатия),  
    - `compression_algo` (алгоритм: zstd/gzip),  
    - `compressed_size` (размер сжатого файла).  
- **Размер**: ≤ 200 байт.  

---

#### 5. Сценарии применения  
##### 5.1 Запуск контейнера в облаке (Kubernetes)  
**Исходные данные:**  
- Thin-manifest образа `nginx:1.25`: содержит intinode-файлы для `/usr/sbin/nginx` и зависимостей.  
- Источник: OCI-registry `oci://registry.example/nginx@sha256:abc123...`.  
- Локальный кеш хоста: пустой.  

**Последовательность действий:**  
1. **Запуск пода:**  
   
2. **Загрузка образа:**  
   - Kubelet скачивает thin-manifest размером 50 КБ (вместо 800 МБ полного образа).  
3. **Первый доступ к `/usr/sbin/nginx`:**  
   - Ядро обнаруживает intinode-файл.  
   - Проверяет кеш: `/var/cache/intinode/sha256/abc123...` — отсутствует.  
   - Передаёт управление `intinode-fetchd`.  
4. **Загрузка из сети:**  
   - Демон запрашивает файл из `oci://registry.example/nginx@sha256:abc123...`.  
   - Верифицирует SHA-256 и размер (6 МБ).  
   - Сохраняет в кеш.  
5. **Последующие контейнеры:**  
   - Все новые поды используют файл из локального кеша.  

**Результат:**  
- трафик при загрузке  - только используемые файлы, и только те кторых нет в локалном кеше.  
- Экономия диска: 794 МБ на контейнер.  

##### 5.2 Запуск AppImage на локальном компьютере  
**Исходные данные:**  
- AppImage `editor-2.0.AppImage` содержит intinode-файлы для библиотек Qt и Python.  
- Источники: `https://cache.example/qt5@sha256:def456...`, `oci://desktop-registry/python@sha256:xyz789...`.  
- Локальный кеш: содержит `qt5` (загружен ранее), но нет `python`.  

**Последовательность действий:**  
1. **Запуск приложения:**  
 
2. **Проверка наличия файлов:**  
   - Для `libQt5Core.so.5` (хеш `def456...`): файл найден в кеше.  
   - Для `libpython3.10.so` (хеш `xyz789...`): кеш пуст.  
3. **Частичная загрузка из сети:**  
   - Демон загружает только отсутствующий файл (2.5 МБ).  
4. **Кеширование:**  
   - Файл сохраняется в кеш и используется для всех приложений с таким хешем.  

**Результат:**  
- Экономия сеста - полная отсутвие дубликации файлов на хосте!

---

#### 6. Требования  
- **Сетевые источники**:  
  - Приоритет: OCI-registry (совместимость с существующей инфраструктурой).  
  - Резервные источники: S3, HTTP, P2P.  
- **Офлайн-режим**:  
  - Предзагрузка: `intinode prefetch <manifest>`.  
  - Локальные зеркала для air-gapped сред.  

---

#### 7. Дополнительные возможности  
- **Сжатие данных**:  
  - Файлы могут храниться в кеше в несжатом виде для быстрого доступа.  
  - Передача по сети: сжатие на лету (алгоритмы: zstd, gzip).  

- **Сервер файлов**:  
  - Интеграция с OCI-registry для хранения content-addressable объектов.  
  - Публичные кеш-серверы у CDN-провайдеров в будущем.  

---

#### 8. Безопасность  
- **Верификация**:  
  - Обязательная проверка хеша и размера после загрузки.  
  - SHA-256 считается криптостойким (коллизии не рассматриваются).  
- **Изоляция демона**:  
  - Работает в отдельном namespace с правами только на запись в `/var/cache/intinode/`.  
- **Защита кеша**:  
  - Доступ для записи только для root и демона. Файлы в кеше неизменяемы после записи (атрибут `chattr +i`).  


#### 9. Заключение  
**intinode** — архитектурное решение для системной проблемы избыточного хранения данных. Оно:  
- Устраняет 85–90% дубликатов в облаках.  
- Ускоряет запуск приложений.  
- Сохраняет совместимость с существующей экосистемой.  

**Эффект для облака:**  
- Годовая экономия на хранении данных.  
- Увеличение плотности размещения.
- Сокращение трафика внутри сети. 


P.S. Концепция intinode находится на стадии предложения. Для перехода к реализации необходимы обсуждения с сообществом разработчиков ядра Linux, инженерами cloud-провайдеров и экспертами по стандартизации. Готов к диалогу и совместной проработке деталей.

